name: Deploy Greenpea

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Verify secrets are configured
      run: |
        missing=""
        if [ -z "$HOST" ]; then missing="$missing HOST"; fi
        if [ -z "$USER" ]; then missing="$missing USER"; fi
        if [ -z "$KEY" ]; then missing="$missing KEY"; fi
        if [ -n "$missing" ]; then
          echo "::error::Missing required secrets:$missing"
          exit 1
        fi
        echo "All required secrets are configured."
      env:
        HOST: ${{ secrets.HOST }}
        USER: ${{ secrets.USER }}
        KEY: ${{ secrets.KEY }}

    - name: Deploy to PRODUCTION
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.KEY }}
        script: |
          set -e
          cd /var/www/apps/greenpea/greenpea-app

          php artisan down --refresh=15 || true

          git pull origin main

          composer install --no-dev --no-interaction --optimize-autoloader

          npm ci --no-audit
          npm run build

          php artisan migrate --no-interaction --force

          php artisan optimize
          php artisan filament:optimize

          php artisan queue:restart

          php artisan up || true
