name: Deploy Greenpea

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Verify secrets are configured
      run: |
        missing=""
        if [ -z "$HOST" ]; then missing="$missing HOST"; fi
        if [ -z "$USER" ]; then missing="$missing USER"; fi
        if [ -z "$KEY" ]; then missing="$missing KEY"; fi
        if [ -n "$missing" ]; then
          echo "::error::Missing required secrets:$missing"
          exit 1
        fi
        echo "All required secrets are configured."
      env:
        HOST: ${{ secrets.HOST }}
        USER: ${{ secrets.USER }}
        KEY: ${{ secrets.KEY }}

    - name: Deploying to server, please wait...
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.KEY }}
        script: |
          set -e

          APP_DIR="/var/www/apps/greenpea/greenpea-app"

          echo "Starting deployment..."
          cd $APP_DIR

          # Enable maintenance mode safely
          php artisan down --refresh=15 || true

          echo "Pulling latest code..."
          git fetch origin
          git reset --hard origin/main

          echo "Installing PHP dependencies..."
          composer install --no-dev --no-interaction --optimize-autoloader

          echo "Installing frontend dependencies..."
          npm ci --no-audit --silent
          npm run build

          echo "Running database migrations..."
          php artisan migrate --no-interaction --force

          echo "Clearing and rebuilding caches..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan optimize:clear
          php artisan optimize
          php artisan filament:optimize

          echo "Revive server..."
          php artisan up

          echo "Restarting queues..."
          php artisan queue:restart

          echo "Bringing application up..."
          php artisan up || true

          echo "Deployment completed successfully."
