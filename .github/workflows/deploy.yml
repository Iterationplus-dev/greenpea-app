name: Deploy Greenpea

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Debug - Print host
      run: echo "Host is: ${{ secrets.HOST }}"

    - name: Debug - Check secrets present
      run: |
        if [ -z "${{ secrets.HOST }}" ]; then echo "HOST is empty"; fi
        if [ -z "${{ secrets.USER }}" ]; then echo "USER is empty"; fi
        if [ -z "${{ secrets.KEY }}" ]; then echo "KEY is empty"; fi

    - name: Deploy to PRODUCTION
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.KEY }}
        script: |
          set -e
          cd /var/www/apps/greenpea/greenpea-app

          php artisan down --refresh=15 || true

          git pull origin main

          composer install --no-dev --no-interaction --optimize-autoloader

          npm ci --no-audit
          npm run build

          php artisan migrate --no-interaction --force

          php artisan optimize
          php artisan filament:optimize

          php artisan queue:restart

          php artisan up || true
